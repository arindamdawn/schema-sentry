name: Release

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: "Release version (e.g. 0.2.0)"
        required: true
        type: string
  push:
    branches: [main]
    paths:
      - 'packages/*/package.json'

permissions:
  contents: write
  pull-requests: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    env:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      has_changeset: ${{ steps.check_changeset.outputs.has_changeset }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - id: get_version
        run: echo "version=$(grep '"version"' packages/core/package.json | cut -d'"' -f4)" >> $GITHUB_OUTPUT
      - id: check_changeset
        run: |
          pending=$(find .changeset -type f -name '*.md' | wc -l | tr -d ' ')
          if [ "$pending" != "0" ]; then
            echo "has_changeset=true" >> $GITHUB_OUTPUT
          else
            echo "has_changeset=false" >> $GITHUB_OUTPUT
          fi
      - name: Show version info
        run: |
          echo "Detected version: v${{ steps.get_version.outputs.version }}"
          echo "Has pending changeset: ${{ steps.check_changeset.outputs.has_changeset }}"
          if [ "${{ steps.check_changeset.outputs.has_changeset }}" = "true" ]; then
            echo "Please run 'pnpm changeset version' and commit first."
          fi

  release:
    needs: prepare
    runs-on: ubuntu-latest
    environment: release
    env:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
      - name: Verify Package Versions
        env:
          EXPECTED_VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          node -e "const fs=require('fs'); const expected=process.env.EXPECTED_VERSION; const files=['packages/core/package.json','packages/cli/package.json','packages/next/package.json']; const versions=files.map(f=>({f, v: JSON.parse(fs.readFileSync(f,'utf8')).version})); const mismatches=versions.filter(x=>x.v!==expected); if(mismatches.length){ console.error('Version mismatch:', mismatches); process.exit(1);} console.log('All packages at v' + expected);"
      - name: Build Packages
        run: pnpm --filter=!schema-sentry-example-next-app -r build
      - name: Run Tests
        run: pnpm test
      - name: Configure npm auth
        run: echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
      - name: Publish to npm
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          # Unpublish existing packages if they already exist
          npm unpublish @schemasentry/core@${VERSION} --force 2>/dev/null || true
          npm unpublish @schemasentry/next@${VERSION} --force 2>/dev/null || true
          npm unpublish @schemasentry/cli@${VERSION} --force 2>/dev/null || true
          npm unpublish @schemasentry/react@${VERSION} --force 2>/dev/null || true
          npm unpublish @schemasentry/mcp@${VERSION} --force 2>/dev/null || true
          npm unpublish schema-sentry-vscode@${VERSION} --force 2>/dev/null || true
          # Publish packages
          pnpm release
      - name: Delete existing tag (if any)
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          git tag -d v${VERSION} 2>/dev/null || true
          git push origin :refs/tags/v${VERSION} 2>/dev/null || true
      - name: Create GitHub Release
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          CHANGELOG_CONTENT=$(awk -v VERSION="$VERSION" '/^## \[/ {section=1; if ($2 ~ "^\\[" VERSION "\\]") {found=1; next}} found && /^## / {exit} found' CHANGELOG.md | sed 's/^## \[.*\] - .*//')
          gh release create v${VERSION} \
            --title "v${VERSION}" \
            --notes "$CHANGELOG_CONTENT" \
            --draft=false
